name: GitHub Issue to Jira Sync from Form

on:
  issues:
    types: [opened]

jobs:
  create_jira_issue:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ì—ì„œ í¼ ì…ë ¥ê°’ ì¶”ì¶œí•˜ê¸° (ì´ì „ê³¼ ë™ì¼)
      - name: Parse Issue Form Body
        id: parse_form
        run: |
          body="${{ github.event.issue.body }}"
          
          issuetype=$(echo "$body" | grep -A 1 "### âš¡ï¸ ì´ìŠˆ ìœ í˜•" | tail -n 1 | tr -d '\r')
          echo "issuetype=$issuetype" >> $GITHUB_OUTPUT
          
          epic_number=$(echo "$body" | grep -A 1 "### ğŸŸï¸ ìƒìœ„ ì—í”½ Number" | tail -n 1 | tr -d '\r')
          echo "epic_number=$epic_number" >> $GITHUB_OUTPUT
          
          issue_label=$(echo "$body" | grep -A 1 "### ğŸ·ï¸ ë ˆì´ë¸”" | tail -n 1 | tr -d '\r')
          echo "issue_label=$issue_label" >> $GITHUB_OUTPUT

      # 2. Jira ë¡œê·¸ì¸ ë‹¨ê³„ (ìƒˆë¡œ ì¶”ê°€!)
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 3. Jira ì´ìŠˆ ìƒì„± ë‹¨ê³„ (ìˆ˜ì •ë¨)
      - name: Create Jira Issue
        uses: atlassian/gajira-create@v3
        with:
          project: GURUMATE # ì§€ë¼ í”„ë¡œì íŠ¸ í‚¤
          issuetype: ${{ steps.parse_form.outputs.issuetype }} # í¼ì—ì„œ ì„ íƒí•œ ì´ìŠˆ ìœ í˜•
          summary: ${{ github.event.issue.title }} # ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì œëª©
          description: ${{ github.event.issue.body }} # í¼ ì „ì²´ ë‚´ìš©ì„ ì§€ë¼ ì„¤ëª…ìœ¼ë¡œ
          
          # ğŸ‘‡ 'epic', 'labels' ë“±ì„ 'fields' ì•ˆì— JSON í˜•ì‹ìœ¼ë¡œ ì „ë‹¬
          fields: |
            {
              "parent": { "key": "${{ steps.parse_form.outputs.epic_number }}" },
              "labels": ["${{ steps.parse_form.outputs.issue_label }}"]
            }
