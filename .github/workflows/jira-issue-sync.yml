name: GitHub Issue to Jira Sync from Form

on:
  issues:
    types: [opened] # ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰

jobs:
  create_jira_issue:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ì—ì„œ í¼ ì…ë ¥ê°’ ì¶”ì¶œí•˜ê¸°
      - name: Parse Issue Form Body
        id: parse_form
        run: |
          body="${{ github.event.issue.body }}"
          
          # "### âš¡ï¸ ì´ìŠˆ ìœ í˜•" ì„¹ì…˜ ì•„ë˜ì˜ ê°’ì„ ì¶”ì¶œ
          issuetype=$(echo "$body" | grep -A 1 "### âš¡ï¸ ì´ìŠˆ ìœ í˜•" | tail -n 1)
          echo "issuetype=$issuetype" >> $GITHUB_OUTPUT
          
          # "### ğŸŸï¸ ìƒìœ„ ì—í”½ Number" ì„¹ì…˜ ì•„ë˜ì˜ ê°’ì„ ì¶”ì¶œ
          epic_number=$(echo "$body" | grep -A 1 "### ğŸŸï¸ ìƒìœ„ ì—í”½ Number" | tail -n 1)
          echo "epic_number=$epic_number" >> $GITHUB_OUTPUT
          
          # "### ğŸ·ï¸ ë ˆì´ë¸”" ì„¹ì…˜ ì•„ë˜ì˜ ê°’ì„ ì¶”ì¶œ
          issue_label=$(echo "$body" | grep -A 1 "### ğŸ·ï¸ ë ˆì´ë¸”" | tail -n 1)
          echo "issue_label=$issue_label" >> $GITHUB_OUTPUT

      # 2. ì¶”ì¶œí•œ ê°’ìœ¼ë¡œ ì§€ë¼ ì´ìŠˆ ìƒì„±í•˜ê¸°
      - name: Create Jira Issue
        uses: atlassian/gajira-create@v3
        with:
          project: GURUMATE # ë³¸ì¸ì˜ ì§€ë¼ í”„ë¡œì íŠ¸ í‚¤
          issuetype: ${{ steps.parse_form.outputs.issuetype }} # í¼ì—ì„œ ì„ íƒí•œ ì´ìŠˆ ìœ í˜•
          summary: ${{ github.event.issue.title }} # ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì œëª©
          description: ${{ github.event.issue.body }} # í¼ ì „ì²´ ë‚´ìš©ì„ ì§€ë¼ ì„¤ëª…ìœ¼ë¡œ
          epic: ${{ steps.parse_form.outputs.epic_number }} # í¼ì—ì„œ ì…ë ¥í•œ ìƒìœ„ ì—í”½
          labels: ${{ steps.parse_form.outputs.issue_label }} # í¼ì—ì„œ ì…ë ¥í•œ ë ˆì´ë¸”

          # ê¹ƒí—ˆë¸Œ ë ˆí¬ì§€í† ë¦¬ Secretsì— ë¯¸ë¦¬ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
          jira_base_url: ${{ secrets.JIRA_BASE_URL }}
          jira_user_email: ${{ secrets.JIRA_USER_EMAIL }}
          jira_api_token: ${{ secrets.JIRA_API_TOKEN }}