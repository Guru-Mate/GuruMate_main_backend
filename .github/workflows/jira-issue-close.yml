name: GitHub Issue Close to Jira Transition

on:
  issues:
    types: [closed] # ê¹ƒí—ˆë¸Œ ì´ìŠˆê°€ ë‹«í˜”ì„ ë•Œ ì‹¤í–‰

jobs:
  transition_jira_issue:
    runs-on: ubuntu-latest
    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ê³¼ ëŒ“ê¸€ì—ì„œ Jira ì´ìŠˆ í‚¤(ì˜ˆ: SCRUM-123) ì°¾ê¸°
      - name: Find Jira Issue Key
        id: find_key
        run: |
          issue_body="${{ github.event.issue.body }}"
          
          # ëŒ“ê¸€ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” API í˜¸ì¶œ
          comments_url="${{ github.event.issue.comments_url }}"
          comments=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$comments_url")
          
          # ë³¸ë¬¸ê³¼ ëŒ“ê¸€ì„ í•©ì³ì„œ Jira í‚¤ ê²€ìƒ‰
          content_to_search="$issue_body $comments"
          
          # ì •ê·œì‹ì„ ì‚¬ìš©í•´ 'SCRUM-ìˆ«ì' í˜•ì‹ì˜ í‚¤ë¥¼ ì°¾ìŒ
          jira_key=$(echo "$content_to_search" | grep -oE 'SCRUM-[0-9]+' | head -n 1)
          
          if [[ -n "$jira_key" ]]; then
            echo "Jira Key Found: $jira_key"
            echo "key=$jira_key" >> $GITHUB_OUTPUT
          else
            echo "Jira Key not found."
          fi

      # 2. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        if: steps.find_key.outputs.key # Jira í‚¤ë¥¼ ì°¾ì•˜ì„ ë•Œë§Œ ì‹¤í–‰
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 3. Jira ì´ìŠˆ ìƒíƒœë¥¼ 'ì™„ë£Œ(Done)'ë¡œ ë³€ê²½
      - name: Transition Jira Issue
        if: steps.find_key.outputs.key # Jira í‚¤ë¥¼ ì°¾ì•˜ì„ ë•Œë§Œ ì‹¤í–‰
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.find_key.outputs.key }}
          transition: "ê°œë°œ ì¢…ë£Œ" # ğŸ‘ˆ ì¤‘ìš”: Jira ì›Œí¬í”Œë¡œìš°ì˜ 'ì™„ë£Œ' ìƒíƒœ ì´ë¦„
